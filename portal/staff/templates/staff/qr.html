{% extends "staff/base/base.html" %}
{% load static custom_components compress %}
{% block title %}KM1151 - Staff Area{% endblock %}
{% block content %}
  <style>
      #preview {
          width: 300px;
          height: 300px;
          border: 1px solid red;
          /* Temporary border to see the element */
      }
  </style>
  <section id="SingleFuelOrder" class="mx-6 md:mx-10">
    <form method="post">
      {% csrf_token %}
      <div class="tw-bigform !bg-pantone7472c">
        <div class="flex flex-col items-center justify-between space-y-4">
          <span class="text-white font-bold">Operation Code</span>
          {{ form.operation_code }}
        </div>
        <div class="w-full rounded-md bg-white flex p-1 mt-2 justify-center items-center">
          <!-- Video element to display the camera feed -->
          <video id="preview">
          </video>
          <!-- Canvas element to process the video frames -->
          <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <menu class="w-full p-6 flex justify-center drop-shadow-lg">
          <div class="col-span2 bg-pantone7472c p-0.5 rounded-l-full w-fit h-fit">
            <div class="border-2 border-sky-200 p-0.5 rounded-l-full flex justify-center items-center">
              <button class="flex whitespace-nowrap w-fit px-4 py-2 rounded-full bg-pantone7472c text-white font-rubik font-bold lowercase text-center"
                      type="submit">Abrir Orden</button>
            </div>
          </div>
          <div class="col-span2 bg-pantone7472c p-0.5 rounded-r-full w-fit h-fit">
            <div class="border-2 border-sky-200 p-0.5 rounded-r-full flex justify-center items-center">
              <a href="{% url 'staff_home' %}"
                 class="flex whitespace-nowrap w-fit px-4 py-2 rounded-full bg-pantone7472c text-white font-rubik font-bold lowercase text-center">Volver</a>
            </div>
          </div>
        </menu>
      </div>
    </form>
    {% if form.errors %}
      <div class="flex w-full justify-center">
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 max-w-fit py-3 rounded relative"
             role="alert">
          <ul>
            {% for field, errors in form.errors.items %}
              {% for error in errors %}<li>{{ error }}</li>{% endfor %}
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}
    {% if messages %}
      <div class="flex w-full justify-center">
        {% for message in messages %}
          <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 max-w-fit py-3 rounded relative"
               role="alert">
            <ul>
              <li>{{ message }}</li>
            </ul>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>
  {% include "staff/base/navbar.html" %}
{% endblock %}
{% block scripts %}
  <script src="{% static 'js/cdn.jsdelivr.net_npm_jsqr@1.3.0_dist_jsQR.min.js' %}"></script>
  <script>
      // JavaScript code for QR code scanning
      const video = document.getElementById('preview');
      const canvasElement = document.getElementById('canvas');
      const canvas = canvasElement.getContext('2d');

      // Request access to the device's camera with the rear-facing camera preference
      navigator.mediaDevices.getUserMedia({
              video: {
                  facingMode: 'environment'
              }
          })
          .then(function(stream) {
              video.srcObject = stream;
              video.setAttribute('playsinline', true); //iOS
              video.play();
              requestAnimationFrame(tick);
          })
          .catch(function(error) {
              console.error('An error occurred when accessing the camera:', error);
          });


      function tick() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvasElement.hidden = false;

              canvasElement.height = video.videoHeight;
              canvasElement.width = video.videoWidth;
              canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
              const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                  inversionAttempts: 'dontInvert',
              });
              if (code) {
                  // Send the decoded text to the server
                  sendToServer(code.data);
              }
          }
          requestAnimationFrame(tick);
      }

      function sendToServer(decodedText) {
          fetch("{% url 'handle_qr_code' %}", {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{ csrf_token }}'
                  },
                  body: JSON.stringify({
                      decoded_text: decodedText
                  })
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      // Handle success (e.g., redirect to another page, show a success message, etc.)
                  } else {
                      // Handle error
                  }
              })
              .catch(error => {
                  console.error('Error sending QR code to server:', error);
              });
      }
  </script>
{% endblock %}
